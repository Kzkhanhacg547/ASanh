<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✨ Thế giới diệu kỳ - THPT A Sanh ✨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Quicksand', sans-serif;
        }
        
        body {
            background-color: #fef6ff;
            background-image: url('https://haycafe.vn/wp-content/uploads/2022/04/Background-xanh-duong-luon-song-trang.jpg');
        }
        
        .dark-mode {
            background-color: #1a1025;
            color: #f3e0ff;
            background-image: url('https://i.imgur.com/FHEmbS8.png');
        }
        
        .magical-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid #f9c4ff;
            background: rgba(255, 255, 255, 0.85);
        }
        
        .dark-mode .magical-card {
            background: rgba(40, 20, 60, 0.85);
            border: 2px solid #9d7bd8;
        }
        
        .magical-card:hover {
            transform: translateY(-8px) rotate(1deg);
            box-shadow: 0 15px 30px rgba(255, 102, 196, 0.2);
            border-color: #ff66c4;
        }
        
        .dark-mode .magical-card:hover {
            box-shadow: 0 15px 30px rgba(111, 66, 193, 0.3);
            border-color: #7c4dff;
        }
        
        .fade-in {
            opacity: 0;
        }
        
        .cute-btn {
            background: linear-gradient(135deg, #ff9cc2 0%, #f066bc 100%);
            border-radius: 20px;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(255, 102, 196, 0.3);
            border: none;
        }
        
        .cute-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(255, 102, 196, 0.4);
        }
        
        .dark-mode .cute-btn {
            background: linear-gradient(135deg, #9d7bd8 0%, #7c4dff 100%);
            box-shadow: 0 4px 8px rgba(124, 77, 255, 0.3);
        }
        
        .dark-mode .cute-btn:hover {
            box-shadow: 0 6px 12px rgba(124, 77, 255, 0.5);
        }
        
        .dangerous-btn {
            background: linear-gradient(135deg, #ff9cc2 0%, #ff5252 100%);
            border-radius: 20px;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(255, 82, 82, 0.3);
            border: none;
        }
        
        .dangerous-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(255, 82, 82, 0.4);
        }
        
        .media-container {
            max-width: 100%;
            margin: 10px 0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .media-container img, .media-container video {
            max-width: 100%;
            border-radius: 15px;
        }
        
        .audio-container {
            width: 100%;
            margin: 10px 0;
            background: linear-gradient(135deg, #f9c4ff 0%, #f066bc 100%);
            padding: 10px;
            border-radius: 15px;
        }
        
        .dark-mode .audio-container {
            background: linear-gradient(135deg, #7c4dff 0%, #512da8 100%);
        }
        
        .pdf-container {
            width: 100%;
            height: 500px;
            margin: 10px 0;
            border: 3px solid #f9c4ff;
            border-radius: 15px;
            overflow: hidden;
        }
        
        .dark-mode .pdf-container {
            border: 3px solid #9d7bd8;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f9e6ff;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #ff9cc2 0%, #f066bc 100%);
            border-radius: 10px;
        }
        
        .dark-mode ::-webkit-scrollbar-track {
            background: #2c1a40;
        }
        
        .dark-mode ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #9d7bd8 0%, #7c4dff 100%);
        }
        
        /* Magical sparkles */
        .sparkle {
            position: absolute;
            background: white;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            filter: drop-shadow(0 0 6px #ff66c4);
            pointer-events: none;
        }
        
        .dark-mode .sparkle {
            filter: drop-shadow(0 0 6px #7c4dff);
        }
    </style>
</head>
<body class="min-h-screen">
    <nav class="bg-gradient-to-r from-pink-400 to-purple-500 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <a href="/" class="text-xl font-bold flex items-center">
                <i class="fas fa-magic mr-2 animate-pulse"></i>
                <span>✨ THPT A Sanh ✨</span>
            </a>
            <div class="flex items-center space-x-4">
                <a href="/" class="hover:text-pink-200 transition-all">
                    <i class="fas fa-home mr-1"></i> Trang chủ
                </a>
                <a href="/news" class="hover:text-pink-200 font-bold underline transition-all">
                    <i class="fas fa-scroll mr-1"></i> Tin diệu kỳ
                </a>
                <a href="/tuyensinh" class="hover:text-pink-200 transition-all">
                    <i class="fas fa-hat-wizard mr-1"></i> Tuyển sinh
                </a>
                <button id="loginBtn" class="bg-white text-purple-500 px-3 py-1 rounded-full hover:bg-pink-100 transition-all">
                    <i class="fas fa-key mr-1"></i> Hiện thân
                </button>
                <button id="logoutBtn" class="hidden bg-red-400 text-white px-3 py-1 rounded-full hover:bg-red-500 transition-all">
                    <i class="fas fa-door-open mr-1"></i> Ẩn thân
                </button>
                <i id="darkModeToggle" class="fas fa-moon text-xl cursor-pointer hover:text-pink-200 transition-all"></i>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-8 text-center text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-600 dark:from-purple-400 dark:to-pink-400">
            ✨ Tin tức Diệu kỳ và Thông báo Huyền bí ✨
        </h1>

        <div class="mb-8" id="userPanel">
            <div id="loginPanel" class="magical-card p-6 rounded-xl shadow-md mb-4">
                <h2 class="text-xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-500">
                    <i class="fas fa-key mr-2"></i> Lời thần chú khai mở
                </h2>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="username" class="block text-pink-500 dark:text-purple-300 font-medium">
                            <i class="fas fa-user-circle mr-1"></i> Tên hiệu thuật sĩ
                        </label>
                        <input type="text" id="username" class="w-full p-2 border-2 border-pink-200 rounded-full focus:border-pink-400 focus:ring-2 focus:ring-pink-200 dark:bg-purple-900 dark:border-purple-700 dark:text-purple-100 dark:focus:border-purple-500" required>
                    </div>
                    <div>
                        <label for="password" class="block text-pink-500 dark:text-purple-300 font-medium">
                            <i class="fas fa-lock mr-1"></i> Mật ngôn huyền bí
                        </label>
                        <input type="password" id="password" class="w-full p-2 border-2 border-pink-200 rounded-full focus:border-pink-400 focus:ring-2 focus:ring-pink-200 dark:bg-purple-900 dark:border-purple-700 dark:text-purple-100 dark:focus:border-purple-500" required>
                    </div>
                    <button type="submit" class="cute-btn px-4 py-2 rounded-full w-full">
                        <i class="fas fa-sparkles mr-1"></i> Triệu hồi ma thuật
                    </button>
                </form>
            </div>

            <div id="postPanel" class="hidden magical-card p-6 rounded-xl shadow-md mb-4">
                <h2 class="text-xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-500">
                    <i class="fas fa-wand-sparkles mr-2"></i> Tạo câu thần chú mới
                </h2>
                <form id="postForm" class="space-y-4">
                    <div>
                        <label for="postTitle" class="block text-pink-500 dark:text-purple-300 font-medium">
                            <i class="fas fa-star mr-1"></i> Tiêu đề thần chú
                        </label>
                        <input type="text" id="postTitle" class="w-full p-2 border-2 border-pink-200 rounded-full focus:border-pink-400 focus:ring-2 focus:ring-pink-200 dark:bg-purple-900 dark:border-purple-700 dark:text-purple-100 dark:focus:border-purple-500" required>
                    </div>
                    <div>
                        <label for="postContent" class="block text-pink-500 dark:text-purple-300 font-medium">
                            <i class="fas fa-book-open mr-1"></i> Lời thần chú
                        </label>
                        <textarea id="postContent" rows="4" class="w-full p-3 border-2 border-pink-200 rounded-xl focus:border-pink-400 focus:ring-2 focus:ring-pink-200 dark:bg-purple-900 dark:border-purple-700 dark:text-purple-100 dark:focus:border-purple-500" required></textarea>
                    </div>
                    <div>
                        <label for="postFiles" class="block text-pink-500 dark:text-purple-300 font-medium">
                            <i class="fas fa-crystal-ball mr-1"></i> Đồ vật phép thuật kèm theo
                        </label>
                        <input type="file" id="postFiles" multiple class="w-full p-2 border-2 border-pink-200 rounded-xl focus:border-pink-400 focus:ring-2 focus:ring-pink-200 dark:bg-purple-900 dark:border-purple-700 dark:text-purple-100 dark:focus:border-purple-500">
                    </div>
                    <button type="submit" class="cute-btn px-4 py-2 rounded-full w-full">
                        <i class="fas fa-hat-wizard mr-1"></i> Phóng thích phép thuật
                    </button>
                </form>
            </div>
        </div>

        <div id="postsContainer" class="grid grid-cols-1 gap-6">
            <!-- Posts will be loaded here -->
            <div class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-pink-500 border-b-4 border-purple-500"></div>
                <p class="mt-4 text-lg font-medium text-pink-600 dark:text-purple-300">
                    <i class="fas fa-sparkles mr-1"></i> Đang triệu hồi tin tức diệu kỳ...
                </p>
            </div>
        </div>
    </div>

    <div id="notification" class="fixed top-6 right-6 p-4 rounded-xl shadow-lg transform transition-transform duration-500 translate-x-full"></div>

    <script>
        // DOM Elements
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginPanel = document.getElementById('loginPanel');
        const postPanel = document.getElementById('postPanel');
        const loginForm = document.getElementById('loginForm');
        const postForm = document.getElementById('postForm');
        const postsContainer = document.getElementById('postsContainer');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const notification = document.getElementById('notification');

        // Current user state
        let currentUser = null;
        let currentEditIndex = null;

        // Magical sparkles effect
        document.addEventListener('mousemove', function(e) {
            if (Math.random() > 0.95) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = e.pageX + 'px';
                sparkle.style.top = e.pageY + 'px';
                document.body.appendChild(sparkle);
                
                // Animate and remove
                gsap.to(sparkle, {
                    opacity: 0,
                    y: -20,
                    duration: 1,
                    onComplete: () => sparkle.remove()
                });
            }
        });

        // Check if user is already logged in
        async function checkLoginStatus() {
            try {
                const response = await fetch('/user');
                const data = await response.json();
                if (data.username) {
                    currentUser = data.username;
                    showLoggedInUI();
                }
            } catch (error) {
                console.error('✨ Lỗi phép thuật khi kiểm tra đăng nhập:', error);
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'wand-magic-sparkles' : 'skull-crossbones'} mr-2"></i> ${message}`;
            notification.className = `fixed top-6 right-6 p-4 rounded-xl shadow-lg ${type === 'success' ? 'bg-gradient-to-r from-pink-400 to-purple-500' : 'bg-gradient-to-r from-red-400 to-red-600'} text-white font-medium`;

            gsap.to(notification, {
                x: 0,
                duration: 0.7,
                ease: "elastic.out(1, 0.7)"
            });

            setTimeout(() => {
                gsap.to(notification, {
                    x: '120%',
                    duration: 0.5,
                    ease: "power2.in"
                });
            }, 4000);
        }

        // Show UI for logged in users
        function showLoggedInUI() {
            loginBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            loginPanel.classList.add('hidden');
            postPanel.classList.remove('hidden');
        }

        // Show UI for logged out users
        function showLoggedOutUI() {
            loginBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            loginPanel.classList.remove('hidden');
            postPanel.classList.add('hidden');
            currentUser = null;
        }

        // Event Listeners
        loginBtn.addEventListener('click', () => {
            loginPanel.classList.toggle('hidden');
            // Sparkle effect
            gsap.fromTo(loginPanel, 
                {scale: 0.8, opacity: 0}, 
                {scale: 1, opacity: 1, duration: 0.5, ease: "back.out(1.7)"});
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    currentUser = username;
                    showLoggedInUI();
                    showNotification('✨ Đã mở khóa phép thuật thành công! ✨');
                    loginForm.reset();
                    fetchPosts();
                } else {
                    showNotification('Lời thần chú không đúng! Vui lòng thử lại.', 'error');
                }
            } catch (error) {
                console.error('Lỗi phép thuật khi đăng nhập:', error);
                showNotification('Đã xảy ra lỗi phép thuật khi đăng nhập.', 'error');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/logout', {
                    method: 'POST'
                });

                if (response.ok) {
                    showLoggedOutUI();
                    showNotification('✨ Đã biến mất một cách huyền bí! ✨');
                    fetchPosts();
                }
            } catch (error) {
                console.error('Lỗi phép thuật khi đăng xuất:', error);
                showNotification('Đã xảy ra lỗi phép thuật khi đăng xuất.', 'error');
            }
        });

        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const files = document.getElementById('postFiles').files;

            const formData = new FormData();
            formData.append('title', title);
            formData.append('content', content);

            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            try {
                if (currentEditIndex !== null) {
                    // Editing existing post
                    const response = await fetch(`/posts/${currentEditIndex}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ title, content })
                    });

                    if (response.ok) {
                        showNotification('✨ Đã cải biến thần chú thành công! ✨');
                        currentEditIndex = null;
                        document.getElementById('postTitle').value = '';
                        document.getElementById('postContent').value = '';
                        fetchPosts();
                    } else {
                        showNotification('Không thể cải biến thần chú.', 'error');
                    }
                } else {
                    // Creating new post
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        showNotification('✨ Đã phóng thích thần chú thành công! ✨');
                        postForm.reset();
                        fetchPosts();
                    } else {
                        showNotification('Không thể phóng thích thần chú.', 'error');
                    }
                }
            } catch (error) {
                console.error('Lỗi phép thuật khi đăng thần chú:', error);
                showNotification('Đã xảy ra lỗi phép thuật khi đăng thần chú.', 'error');
            }
        });

        // Delete post
        async function deletePost(e) {
            if (!confirm('✨ Bạn có chắc chắn muốn xóa thần chú này? Không thể hoàn tác! ✨')) return;

            const index = e.target.dataset.index;

            try {
                const response = await fetch(`/posts/${index}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('✨ Đã phá hủy thần chú thành công! ✨');
                    fetchPosts();
                } else {
                    showNotification('Không thể phá hủy thần chú.', 'error');
                }
            } catch (error) {
                console.error('Lỗi phép thuật khi xóa thần chú:', error);
                showNotification('Đã xảy ra lỗi phép thuật khi xóa thần chú.', 'error');
            }
        }

        // Edit post
        function editPost(e) {
            const index = e.target.dataset.index;
            const posts = JSON.parse(sessionStorage.getItem('posts') || '[]');
            const post = posts[index];

            document.getElementById('postTitle').value = post.title;
            document.getElementById('postContent').value = post.content;
            currentEditIndex = index;

            postPanel.scrollIntoView({ behavior: 'smooth' });
            
            // Sparkle effect
            gsap.fromTo(postPanel, 
                {scale: 0.95, opacity: 0.8}, 
                {scale: 1, opacity: 1, duration: 0.5, ease: "elastic.out(1, 0.7)"});
        }

        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            darkModeToggle.classList.toggle('fa-moon');
            darkModeToggle.classList.toggle('fa-sun');
            
            // Magical transition
            gsap.to("body", {
                backgroundColor: document.body.classList.contains('dark-mode') ? '#1a1025' : '#fef6ff',
                duration: 0.7,
                ease: "power2.inOut"
            });
        });

        function renderMediaContent(file) {
            if (typeof file === 'string') {
                // For backward compatibility with existing code
                const extension = file.split('.').pop().toLowerCase();
                switch (extension) {
                    case 'pdf':
                        return `<div class="pdf-container" id="pdf-${file}"></div>
                                <script>
                                    pdfjsLib.getDocument('/files/${file}').promise.then(function(pdf) {
                                        pdf.getPage(1).then(function(page) {
                                            var scale = 1.5;
                                            var viewport = page.getViewport({ scale: scale });
                                            var canvas = document.createElement('canvas');
                                            var context = canvas.getContext('2d');
                                            canvas.height = viewport.height;
                                            canvas.width = viewport.width;
                                            var renderContext = {
                                                canvasContext: context,
                                                viewport: viewport
                                            };
                                            page.render(renderContext);
                                            document.getElementById('pdf-${file}').appendChild(canvas);
                                        });
                                    });
                                <\/script>`;
                    case 'mp4':
                    case 'webm':
                    case 'ogg':
                        return `<div class="media-container">
                                    <video controls>
                                        <source src="/files/${file}" type="video/${extension}">
                                        Phép thuật của bạn không đủ mạnh để xem video này.
                                    </video>
                                </div>`;
                    case 'mp3':
                    case 'wav':
                        return `<div class="audio-container">
                                    <audio controls>
                                        <source src="/files/${file}" type="audio/${extension}">
                                        Phép thuật của bạn không đủ mạnh để nghe âm thanh này.
                                    </audio>
                                </div>`;
                    case 'jpg':
                    case 'jpeg':
                    case 'png':
                    case 'gif':
                        return `<div class="media-container">
                                    <img src="/files/${file}" alt="✨ Hình ảnh diệu kỳ ✨">
                                </div>`;
                    default:
                        return `<p>✨ Loại phép thuật không được hỗ trợ: ${extension} ✨</p>`;
                }
            } else {
                // For base64 encoded files
                if (!file.data || !file.contentType) return "<p>✨ Dữ liệu phép thuật không hợp lệ ✨</p>";

                const contentTypePrefix = file.contentType.split('/')[0];
                const fileExtension = file.contentType.split('/')[1];

                switch (contentTypePrefix) {
                    case 'application':
                        if (fileExtension === 'pdf') {
                            return `<div class="pdf-container">
                                        <embed src="data:${file.contentType};base64,${file.data}" type="${file.contentType}" width="100%" height="500px" />
                                    </div>`;
                        } else {
                            return `<p>✨ Cuộn phép thuật: ${file.filename} ✨</p>
                                    <a href="data:${file.contentType};base64,${file.data}" download="${file.filename}" class="cute-btn px-3 py-1 rounded-full inline-block mt-2">
                                        <i class="fas fa-download mr-1"></i> Thu thập phép thuật
                                    </a>`;
                        }
                    case 'video':
                        return `<div class="media-container">
                                    <video controls>
                                        <source src="data:${file.contentType};base64,${file.data}" type="${file.contentType}">
                                        Phép thuật của bạn không đủ mạnh để xem video này.
                                    </video>
                                </div>`;
                    case 'audio':
                        return `<div class="audio-container">
                                    <audio controls>
                                        <source src="data:${file.contentType};base64,${file.data}" type="${file.contentType}">
                                        Phép thuật của bạn không đủ mạnh để nghe âm thanh này.
                                    </audio>
                                </div>`;
                    case 'image':
                        return `<div class="media-container">
                                    <img src="data:${file.contentType};base64,${file.data}" alt="✨ ${file.filename} ✨">
                                </div>`;
                    default:
                        return `<p>✨ Cuộn phép thuật: ${file.filename} ✨</p>
                                <a href="data:${file.contentType};base64,${file.data}" download="${file.filename}" class="cute-btn px-3 py-1 rounded-full inline-block mt-2">
                                    <i class="fas fa-download mr-1"></i> Thu thập phép thuật
                                </a>`;
                }
            }
        }

        function renderPosts(posts) {
            postsContainer.innerHTML = '';
            
            if (posts.length === 0) {
                postsContainer.innerHTML = `
                    <div class="text-center py-12 magical-card rounded-xl">
                        <img src="https://i.pinimg.com/originals/b9/b2/32/b9b232952b22a6dfcee8148f2650129b.gif" alt="Empty magic scroll" class="w-32 mx-auto mb-4">
                        <p class="text-lg font-medium text-pink-600 dark:text-purple-300">
                            ✨ Chưa có thần chú nào được tạo ra ✨
                        </p>
                    </div>
                `;
                return;
            }
            
            posts.forEach((post, index) => {
                const postCard = document.createElement('div');
                postCard.className = 'magical-card p-5 rounded-xl shadow-md fade-in';
                // Format date
                                const postDate = new Date(post.date);
                                const formattedDate = postDate.toLocaleDateString('vi-VN', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });

                                postCard.innerHTML = `
                                    <h3 class="text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-600 dark:from-purple-400 dark:to-pink-400 font-bold text-lg">
                                        <i class="fas fa-sparkles mr-2"></i> ${post.title}
                                    </h3>
                                    <p class="text-gray-700 dark:text-gray-300 my-3">${post.content.replace(/\n/g, '<br>')}</p>
                                    <p class="text-sm italic text-pink-400 dark:text-purple-300">
                                        <i class="fas fa-wand-magic-sparkles mr-1"></i> Phép thuật được tạo bởi 
                                        <span class="font-medium">${post.author}</span> vào 
                                        <span class="font-medium">${formattedDate}</span>
                                    </p>
                                    ${post.files && post.files.length > 0 ? `
                                        <div class="file-list mt-4">
                                            ${post.files.map(file => `
                                                <div class="mb-4">
                                                    ${renderMediaContent(file)}
                                                </div>`).join('')}
                                        </div>
                                    ` : ''}
                                    <div class="flex space-x-3 mt-4 ${(post.author !== currentUser && currentUser !== 'admin') ? 'hidden' : ''}">
                                        <button class="edit-post cute-btn py-1 px-3 rounded-full transition-all duration-300" data-index="${index}">
                                            <i class="fas fa-magic mr-1"></i> Biến đổi
                                        </button>
                                        <button class="delete-post dangerous-btn py-1 px-3 rounded-full transition-all duration-300" data-index="${index}">
                                            <i class="fas fa-skull mr-1"></i> Phá hủy
                                        </button>
                                    </div>
                                `;
                                postsContainer.appendChild(postCard);
                            });

                            // Add event listeners for edit and delete buttons
                            document.querySelectorAll('.delete-post').forEach(button => {
                                button.addEventListener('click', deletePost);
                            });

                            document.querySelectorAll('.edit-post').forEach(button => {
                                button.addEventListener('click', editPost);
                            });

                            // Apply magical fade-in effect
                            gsap.from(".fade-in", {
                                opacity: 0,
                                y: 30,
                                stagger: 0.15,
                                duration: 0.7,
                                ease: "back.out(1.4)"
                            });
                        }

                        // Fetch posts from server
                        async function fetchPosts() {
                            try {
                                const response = await fetch('/posts');
                                const posts = await response.json();
                                sessionStorage.setItem('posts', JSON.stringify(posts));
                                renderPosts(posts);
                            } catch (error) {
                                console.error('✨ Lỗi phép thuật khi triệu hồi thông báo:', error);
                                showNotification('Lỗi khi triệu hồi thần chú. Vui lòng thử lại sau.', 'error');

                                // Display error message in posts container
                                postsContainer.innerHTML = `
                                    <div class="text-center py-12 magical-card rounded-xl">
                                        <img src="https://i.imgur.com/Tn6iJKs.png" alt="Broken magic" class="w-48 mx-auto mb-4">
                                        <p class="text-lg font-medium text-pink-600 dark:text-purple-300">
                                            <i class="fas fa-wand-broken mr-2"></i> Ôi không! Phép thuật đã thất bại!
                                        </p>
                                        <button id="retryBtn" class="cute-btn px-4 py-2 rounded-full mt-4">
                                            <i class="fas fa-sync-alt mr-1"></i> Thử lại phép thuật
                                        </button>
                                    </div>
                                `;

                                document.getElementById('retryBtn').addEventListener('click', fetchPosts);
                            }
                        }

                        // Initialize
                        checkLoginStatus();
                        fetchPosts();

                        // Easter egg - konami code
                        let konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
                        let konamiIndex = 0;

                        document.addEventListener('keydown', function(e) {
                            if (e.key === konamiCode[konamiIndex]) {
                                konamiIndex++;
                                if (konamiIndex === konamiCode.length) {
                                    // Konami code completed!
                                    konamiIndex = 0;
                                    // Create sparkle explosion
                                    for (let i = 0; i < 50; i++) {
                                        setTimeout(() => {
                                            const sparkle = document.createElement('div');
                                            sparkle.className = 'sparkle';
                                            sparkle.style.left = Math.random() * window.innerWidth + 'px';
                                            sparkle.style.top = Math.random() * window.innerHeight + 'px';
                                            document.body.appendChild(sparkle);

                                            gsap.to(sparkle, {
                                                opacity: 0,
                                                scale: 2,
                                                y: -100 * Math.random(),
                                                x: (Math.random() - 0.5) * 200,
                                                duration: 1 + Math.random(),
                                                onComplete: () => sparkle.remove()
                                            });
                                        }, i * 50);
                                    }
                                    showNotification('✨✨✨ Phép thuật bí mật đã được kích hoạt! ✨✨✨');
                                }
                            } else {
                                konamiIndex = 0;
                            }
                        });
                    </script>
                </body>
                </html>
